<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>完整版二十四节气系统</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.2/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lunar-calendar-js@1.0.3/lib/lunar-calendar.min.js"></script>
    <style>
        :root {
            --primary: #2c5f2d;
            --secondary: #97BC62;
            --chart-blue: #5470C6;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f0f3f5;
        }

        .container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            position: relative;
        }

        .nav-buttons {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 1rem;
        }

        .solarterm-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .solarterm-btn {
            padding: 0.8rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .input-group {
            display: flex;
            gap: 1rem;
            margin: 2rem 0;
        }

        input {
            flex: 1;
            padding: 0.8rem;
            border: 2px solid var(--secondary);
            border-radius: 8px;
        }

        button {
            padding: 0.8rem 1.5rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .chart-container {
            height: 400px;
            margin: 2rem 0;
        }

        .result-card {
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .lunar-detail {
            color: #666;
            font-size: 0.9em;
            margin-top: 0.5rem;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="nav-buttons">
            <button onclick="window.location.href='analysis.html'">数据分析</button>
            <button onclick="window.location.href='timeline.html'">历史年表</button>
        </div>

        <h2>二十四节气查询系统</h2>
        <div class="solarterm-grid" id="grid"></div>

        <div class="input-group">
            <input type="text" id="yearInput" placeholder="输入年份（如：贞观八年 或 2023）">
            <button onclick="SolarTermApp.calculate()">立即查询</button>
        </div>

        <div class="result-card">
            <h3>公历日期</h3>
            <p id="gregDate">-</p>
            <h3>农历详情</h3>
            <p id="lunarDate">-</p>
            <div class="lunar-detail" id="lunarDetail"></div>
        </div>

        <div class="chart-container" id="chart"></div>
    </div>

    <script>
        // 完整24节气配置（公元前221年-公元3000年）
        const SolarTerms = {
            config: {
                '立春': { month: 2, c: [[3.87, 21], [4.15, 22]], L: y => Math.floor((y - 1) / 4), exceptions: {} },
                '雨水': { month: 2, c: [[18.73, 21]], L: y => Math.floor((y - 1) / 4), exceptions: { 2026: -1 } },
                '惊蛰': { month: 3, c: [[5.63, 21]], L: y => Math.floor((y - 1) / 4), exceptions: {} },
                '春分': { month: 3, c: [[20.646, 21]], L: y => Math.floor(y / 4), exceptions: { 2084: 1 } },
                '清明': { month: 4, c: [[4.81, 21], [5.59, 20]], L: y => Math.floor(y / 4), exceptions: {} },
                '谷雨': { month: 4, c: [[20.1, 21], [20.888, 20]], L: y => Math.floor(y / 4), exceptions: {} },
                '立夏': { month: 5, c: [[5.52, 21], [6.318, 20]], L: y => Math.floor(y / 4), exceptions: { 1911: 1 } },
                '小满': { month: 5, c: [[21.04, 21], [21.86, 20]], L: y => Math.floor(y / 4), exceptions: { 2008: 1 } },
                '芒种': { month: 6, c: [[5.678, 21], [6.5, 20]], L: y => Math.floor(y / 4), exceptions: { 1902: 1 } },
                '夏至': { month: 6, c: [[21.37, 21], [22.20, 20]], L: y => Math.floor(y / 4), exceptions: { 1928: 1 } },
                '小暑': { month: 7, c: [[7.108, 21], [7.928, 20]], L: y => Math.floor(y / 4), exceptions: { 1925: 1, 2016: 1 } },
                '大暑': { month: 7, c: [[22.83, 21], [23.65, 20]], L: y => Math.floor(y / 4), exceptions: { 1922: 1 } },
                '立秋': { month: 8, c: [[7.5, 21], [8.35, 20]], L: y => Math.floor(y / 4), exceptions: { 2002: 1 } },
                '处暑': { month: 8, c: [[23.13, 21], [23.95, 20]], L: y => Math.floor(y / 4), exceptions: {} },
                '白露': { month: 9, c: [[7.646, 21], [8.44, 20]], L: y => Math.floor(y / 4), exceptions: { 1927: 1 } },
                '秋分': { month: 9, c: [[23.042, 21], [23.822, 20]], L: y => Math.floor(y / 4), exceptions: { 1942: 1 } },
                '寒露': { month: 10, c: [[8.318, 21], [9.098, 20]], L: y => Math.floor(y / 4), exceptions: {} },
                '霜降': { month: 10, c: [[23.438, 21], [24.218, 20]], L: y => Math.floor(y / 4), exceptions: { 2089: 1 } },
                '立冬': { month: 11, c: [[7.438, 21], [8.218, 20]], L: y => Math.floor(y / 4), exceptions: { 2089: 1 } },
                '小雪': { month: 11, c: [[22.36, 21], [23.08, 20]], L: y => Math.floor(y / 4), exceptions: { 1978: 1 } },
                '大雪': { month: 12, c: [[7.18, 21], [7.9, 20]], L: y => Math.floor(y / 4), exceptions: { 1954: 1 } },
                '冬至': { month: 12, c: [[21.94, 21], [22.60, 20]], L: y => Math.floor(y / 4), exceptions: { 1918: -1, 2021: -1 } },
                '小寒': { month: 1, c: [[5.4055, 21], [6.11, 20]], L: y => Math.floor((y - 1) / 4), exceptions: { 1982: 1, 2019: -1 } },
                '大寒': { month: 1, c: [[20.12, 21], [20.84, 20]], L: y => Math.floor((y - 1) / 4), exceptions: { 2082: 1 } }
            },

            eras: [
                {
                    name: "唐", start: 618, end: 907,
                    periods: [
                        { name: "贞观", start: 627, end: 649, emperor: "李世民" },
                        { name: "开元", start: 713, end: 741, emperor: "李隆基" }
                    ]
                },
                {
                    name: "宋", start: 960, end: 1279,
                    periods: [
                        { name: "南宋", start: 1127, end: 1279 }
                    ]
                }
            ],

            calculateTerm(year, term) {
                if (year < -221 || year > 3000) throw new Error("超出计算范围");

                const config = this.config[term];
                const y = year % 100;
                const century = Math.ceil(year / 100);

                // 获取对应世纪的C值
                const cData = config.c.find(([_, c]) => c === century);
                const c = cData ? cData[0] : config.c[0][0];

                // 计算基础值
                let day = Math.floor(y * 0.2422 + c) - config.L(y);

                // 应用例外调整
                day += config.exceptions[year] || 0;

                // 处理公元前年份
                const jsYear = year < 1 ? year + 1 : year;
                const date = new Date(jsYear, config.month - 1, day);

                // 处理跨月情况
                if (date.getMonth() !== config.month - 1) {
                    date.setMonth(config.month - 1);
                    date.setDate(day);
                }

                return date;
            },

            getLunarDetail(date) {
                try {
                    const lunar = LunarCalendar.solarToLunar(
                        date.getFullYear(),
                        date.getMonth() + 1,
                        date.getDate()
                    );

                    return {
                        dateStr: `${lunar.lYear}年 ${lunar.monthStr}${lunar.dayStr}`,
                        zodiac: lunar.zodiac,
                        festival: lunar.festival || lunar.term || '',
                        ganZhi: lunar.GanZhiYear + '年'
                    };
                } catch (e) {
                    return { error: "农历计算失败" };
                }
            },

            getEraInfo(year) {
                const era = this.eras.find(e => year >= e.start && year <= e.end);
                if (!era) return { info: "未知时期" };

                let detail = era.name;
                if (era.periods) {
                    const period = era.periods.find(p => year >= p.start && year <= p.end);
                    if (period) {
                        const eraYear = year - period.start + 1;
                        detail += ` ${period.name}${this.toChineseYear(eraYear)}`;
                        detail += `（${period.emperor}）`;
                    }
                }
                return { info: detail };
            },

            toChineseYear(num) {
                const digits = ['', '一', '二', '三', '四', '五', '六', '七', '八', '九'];
                if (num === 1) return '元年';
                if (num <= 10) return digits[num] + '年';
                if (num < 20) return `十${digits[num % 10]}`;
                return `${digits[Math.floor(num / 10)]}十${digits[num % 10]}`;
            }
        };

        // 应用控制器
        const SolarTermApp = {
            currentTerm: '立春',
            chart: null,

            init() {
                this.renderTerms();
                this.initChart();
                this.addTestData();
            },

            renderTerms() {
                const grid = document.getElementById('grid');
                Object.keys(SolarTerms.config).forEach(term => {
                    const btn = document.createElement('button');
                    btn.className = 'solarterm-btn';
                    btn.textContent = term;
                    btn.onclick = () => this.selectTerm(term);
                    grid.appendChild(btn);
                });
            },

            selectTerm(term) {
                this.currentTerm = term;
                this.calculate();
            },

            calculate() {
                const input = document.getElementById('yearInput').value;
                try {
                    const year = this.parseInput(input);
                    const date = SolarTerms.calculateTerm(year, this.currentTerm);
                    this.displayResult(year, date);
                    this.updateChart(year);
                } catch (e) {
                    alert(`错误：${e.message}`);
                }
            },

            parseInput(input) {
                // 处理年号格式（如：贞观八年）
                const eraMatch = input.match(/([\u4e00-\u9fa5]{2,})([元一二三四五六七八九十百]+)/);
                if (eraMatch) {
                    const eraName = eraMatch[1];
                    const eraYear = SolarTermApp.chineseToNumber(eraMatch[2]);

                    const dynasty = SolarTerms.eras.find(d =>
                        d.periods?.some(p => p.name === eraName)
                    );
                    if (!dynasty) throw new Error("未找到匹配年号");

                    const period = dynasty.periods.find(p => p.name === eraName);
                    return period.start + eraYear - 1;
                }

                // 处理纯数字输入
                return parseInt(input);
            },

            chineseToNumber(cn) {
                const map = { 元: 1, 一: 1, 二: 2, 三: 3, 四: 4, 五: 5, 六: 6, 七: 7, 八: 8, 九: 9, 十: 10 };
                return [...cn].reduce((sum, c) => sum + (map[c] || 0), 0);
            },

            displayResult(year, date) {
                // 公历日期
                const gregYear = date.getFullYear();
                document.getElementById('gregDate').textContent =
                    `${gregYear}年${date.getMonth() + 1}月${date.getDate()}日`;

                // 农历信息
                const lunar = SolarTerms.getLunarDetail(date);
                if (!lunar.error) {
                    document.getElementById('lunarDate').textContent = lunar.dateStr;
                    document.getElementById('lunarDetail').innerHTML = `
                ${lunar.ganZhi}（${lunar.zodiac}）<br>
                节气/节日：${lunar.festival}
            `;
                }

                // 历史纪年
                const eraInfo = SolarTerms.getEraInfo(year);
                document.querySelector('.result-card h3').innerHTML +=
                    `<div class="lunar-detail">${eraInfo.info}</div>`;
            },

            initChart() {
                this.chart = echarts.init(document.getElementById('chart'));
                this.chart.setOption({
                    title: { text: '百年趋势分析', left: 'center' },
                    tooltip: { trigger: 'axis' },
                    xAxis: { type: 'category' },
                    yAxis: { type: 'value' },
                    series: [{
                        type: 'line',
                        smooth: true,
                        areaStyle: { color: 'rgba(84, 112, 198, 0.2)' }
                    }]
                });
            },

            updateChart(baseYear) {
                const years = [];
                const days = [];

                for (let y = baseYear - 50; y <= baseYear + 50; y++) {
                    try {
                        const date = SolarTerms.calculateTerm(y, this.currentTerm);
                        days.push(date.getDate());
                        years.push(y);
                    } catch { }
                }

                this.chart.setOption({
                    xAxis: { data: years },
                    series: [{ data: days }]
                });
            },

            addTestData() {
                // 验证2023年立春（2月4日）
                console.assert(
                    SolarTerms.calculateTerm(2023, '立春').getDate() === 4,
                    "2023立春计算错误"
                );

                // 验证贞观八年（634年）
                console.assert(
                    this.parseInput("贞观八年") === 634,
                    "年号转换错误"
                );
            }
        };

        // 初始化应用
        SolarTermApp.init();
    </script>
</body>

</html>