<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>历史节气分析系统</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.2/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.3.6/dist/lunar.min.js"></script>
    <style>
        :root {
            --primary: #2c5f2d;
            --secondary: #97BC62;
            --chart-blue: #5470C6;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 0;
            background: url('https://images.unsplash.com/photo-1601662521367-b92d7b228c39') no-repeat center/cover fixed;
            min-height: 100vh;
            position: relative;
        }

        body::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.85);
            z-index: -1;
        }

        .nav-bar {
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .nav-btn {
            padding: 0.8rem 1.5rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin: 20px auto;
            max-width: 1200px;
            position: relative;
        }

        .solarterm-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .solarterm-btn {
            padding: 0.8rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .solarterm-btn.active {
            background: var(--chart-blue);
            transform: scale(1.05);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .input-group {
            display: flex;
            gap: 1rem;
            margin: 2rem 0;
        }

        input {
            flex: 1;
            padding: 0.8rem;
            border: 2px solid var(--secondary);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input:focus {
            border-color: var(--chart-blue);
            outline: none;
        }

        .result-card {
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 1rem 0;
            position: relative;
        }

        .era-display {
            position: absolute;
            right: 1rem;
            top: 1rem;
            background: var(--secondary);
            color: white;
            padding: 0.3rem 1rem;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .chart-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .chart-modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            width: 80%;
            height: 70%;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            transition: color 0.2s;
        }

        .close-btn:hover {
            color: var(--primary);
        }

        .chart-container {
            height: calc(100% - 40px);
            margin-top: 1rem;
        }

        .lunar-info {
            color: #444;
            line-height: 1.8;
            padding: 0.5rem 0;
        }

        .error {
            color: #dc3545;
            font-weight: bold;
        }

        .chart-trigger {
            position: absolute;
            right: 2rem;
            bottom: 2rem;
            padding: 0.8rem 1.5rem;
            background: var(--chart-blue);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chart-trigger:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>

<body>
    <div class="nav-bar">
        <button class="nav-btn" onclick="location.href='index.html'">节气分析</button>
        <button class="nav-btn" onclick="location.href='weather.html'">天气数据</button>
        <button class="nav-btn" onclick="location.href='crops.html'">作物生长</button>
        <button class="nav-btn" onclick="location.href='history.html'">历史记录</button>
    </div>

    <div class="container">
        <h1>历史节气分析系统</h1>

        <div class="solarterm-grid" id="termGrid"></div>

        <div class="input-group">
            <input type="text" id="yearInput" placeholder="输入年份（示例：贞观八年、宋宝庆三年、2023）" autocomplete="off">
            <button class="solarterm-btn" onclick="system.calculate()">立即查询</button>
        </div>

        <div class="result-card">
            <div class="era-display" id="eraDisplay"></div>
            <h3>公历日期</h3>
            <p id="gregDate">-</p>
            <h3>农历详情</h3>
            <div id="lunarDate" class="lunar-info">-</div>
        </div>

        <button class="chart-trigger" onclick="system.showChart()">查看年度图表</button>
    </div>

    <div class="chart-modal" id="chartModal">
        <div class="modal-content">
            <span class="close-btn" onclick="system.hideChart()">×</span>
            <div class="chart-container" id="mainChart"></div>
        </div>
    </div>

    <script>
        const ERA_DB = [
            { name: "夏", start: -2070, end: -1600 },
            { name: "商", start: -1600, end: -1046 },
            { name: "西周", start: -1046, end: -771 },
            { name: "东周", start: -770, end: -256 },
            { name: "秦", start: -221, end: -207 },
            { name: "西汉", start: -202, end: 8 },
            { name: "东汉", start: 25, end: 220 },
            { name: "三国", start: 220, end: 280 },
            { name: "西晋", start: 265, end: 317 },
            { name: "东晋", start: 317, end: 420 },
            { name: "隋", start: 581, end: 618 },
            { name: "唐", start: 618, end: 907 },
            { name: "北宋", start: 960, end: 1127 },
            { name: "南宋", start: 1127, end: 1279 },
            { name: "元", start: 1271, end: 1368 },
            { name: "明", start: 1368, end: 1644 },
            { name: "清", start: 1636, end: 1912 }
        ];

        const SOLAR_TERMS = {
            '立春': { order: 3, coefficients: [3.87, 0.2422], month: 2 },
            '雨水': { order: 4, coefficients: [18.73, 0.2422], month: 2 },
            '惊蛰': { order: 5, coefficients: [5.63, 0.2422], month: 3 },
            '春分': { order: 6, coefficients: [20.646, 0.2422], month: 3 },
            '清明': { order: 7, coefficients: [4.81, 0.2422], month: 4 },
            '谷雨': { order: 8, coefficients: [20.1, 0.2422], month: 4 },
            '立夏': { order: 9, coefficients: [5.52, 0.2422], month: 5 },
            '小满': { order: 10, coefficients: [21.04, 0.2422], month: 5 },
            '芒种': { order: 11, coefficients: [5.678, 0.2422], month: 6 },
            '夏至': { order: 12, coefficients: [21.37, 0.2422], month: 6 },
            '小暑': { order: 13, coefficients: [7.108, 0.2422], month: 7 },
            '大暑': { order: 14, coefficients: [22.83, 0.2422], month: 7 },
            '立秋': { order: 15, coefficients: [7.5, 0.2422], month: 8 },
            '处暑': { order: 16, coefficients: [23.13, 0.2422], month: 8 },
            '白露': { order: 17, coefficients: [7.646, 0.2422], month: 9 },
            '秋分': { order: 18, coefficients: [23.042, 0.2422], month: 9 },
            '寒露': { order: 19, coefficients: [8.318, 0.2422], month: 10 },
            '霜降': { order: 20, coefficients: [23.438, 0.2422], month: 10 },
            '立冬': { order: 21, coefficients: [7.438, 0.2422], month: 11 },
            '小雪': { order: 22, coefficients: [22.36, 0.2422], month: 11 },
            '大雪': { order: 23, coefficients: [7.18, 0.2422], month: 12 },
            '冬至': { order: 24, coefficients: [21.94, 0.2422], month: 12 },
            '小寒': { order: 1, coefficients: [5.4055, 0.2422], month: 1 },
            '大寒': { order: 2, coefficients: [20.12, 0.2422], month: 1 }
        };

        class SolarSystem {
            constructor() {
                this.currentTerm = '立春';
                this.chart = null;
                this.currentYear = new Date().getFullYear();
                this.init();
            }

            init() {
                this.renderTerms();
                this.initChart();
                this.bindEvents();
            }

            renderTerms() {
                const grid = document.getElementById('termGrid');
                grid.innerHTML = '';
                Object.keys(SOLAR_TERMS).forEach(term => {
                    const btn = document.createElement('button');
                    btn.className = `solarterm-btn ${term === this.currentTerm ? 'active' : ''}`;
                    btn.textContent = term;
                    btn.addEventListener('click', () => this.selectTerm(term));
                    grid.appendChild(btn);
                });
            }

            selectTerm(term) {
                this.currentTerm = term;
                document.querySelectorAll('.solarterm-btn').forEach(btn =>
                    btn.classList.remove('active')
                );
                event.target.classList.add('active');
            }

            calculate() {
                try {
                    const input = document.getElementById('yearInput').value.trim();
                    if (!input) throw new Error("请输入有效年份");

                    this.currentYear = this.parseInput(input);
                    const date = this.calcSolarTerm(this.currentYear);
                    this.updateDisplay(date);
                } catch (e) {
                    alert(`操作失败：${e.message}`);
                    console.error(e);
                }
            }

            parseInput(input) {
                // 年号解析逻辑
                const eraMatch = input.match(/^([\u4e00-\u9fa5]+)([元一二三四五六七八九十百]+)$/);
                if (eraMatch) {
                    const era = eraMatch[1];
                    const chineseYear = eraMatch[2];
                    return this.parseEra(era, chineseYear);
                }

                if (/^-?\d+$/.test(input)) {
                    const year = parseInt(input);
                    if (year < -221 || year > 3000) throw new Error("年份超出计算范围");
                    return year;
                }

                throw new Error("无法识别的输入格式");
            }

            parseEra(era, chineseYear) {
                const dynasty = ERA_DB.find(d => d.name.startsWith(era));
                if (!dynasty) throw new Error("未找到对应朝代");
                return dynasty.start + this.chineseToNumber(chineseYear) - 1;
            }

            chineseToNumber(str) {
                const map = {
                    元: 1, 一: 1, 二: 2, 三: 3, 四: 4, 五: 5,
                    六: 6, 七: 7, 八: 8, 九: 9, 十: 10,
                    廿: 20, 卅: 30
                };

                let total = 0;
                let temp = 0;

                for (const char of str) {
                    const value = map[char];
                    if (value >= 10) {
                        total += temp * value;
                        temp = 0;
                    } else {
                        temp = temp * 10 + value;
                    }
                }
                return total + temp;
            }

            calcSolarTerm(year) {
                const config = SOLAR_TERMS[this.currentTerm];
                const century = Math.floor(year / 100) + 1;
                const y = year % 100;

                let date = Math.floor(century * config.coefficients[1] * y + config.coefficients[0])
                    - Math.floor((century - 1) / 4);

                // 构造日期对象（处理公元前）
                const jsYear = year < 0 ? year + 1 : year;
                const resultDate = new Date(jsYear, config.month - 1, 1);
                resultDate.setDate(Math.min(date, 31));
                return resultDate;
            }

            updateDisplay(date) {
                // 公历显示
                document.getElementById('gregDate').textContent =
                    `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;

                // 农历显示
                const lunar = this.getLunar(date);
                const lunarHTML = lunar.error ?
                    `<div class="error">${lunar.error}</div>` :
                    `<div>农历：${lunar.year} ${lunar.month}${lunar.day}</div>
                     <div>干支：${lunar.ganzhi}年 · ${lunar.zodiac}年</div>
                     ${lunar.festival ? `<div>节气/节日：${lunar.festival}</div>` : ''}`;
                document.getElementById('lunarDate').innerHTML = lunarHTML;

                // 历史时期
                this.updateEraDisplay(date.getFullYear());
            }

            getLunar(date) {
                try {
                    const solar = Lunar.fromDate(date);
                    return {
                        year: solar.getYearInChinese(),
                        month: solar.getMonthInChinese(),
                        day: solar.getDayInChinese(),
                        ganzhi: solar.getYearInGanZhi(),
                        zodiac: solar.getYearShengXiao(),
                        festival: solar.getFestivals().join(' ') || solar.getJieQi()
                    };
                } catch (e) {
                    return { error: "农历转换失败" };
                }
            }

            updateEraDisplay(year) {
                const era = ERA_DB.find(e => year >= e.start && year <= e.end);
                document.getElementById('eraDisplay').textContent = era ? era.name : '未知时期';
            }

            // 图表功能
            initChart() {
                this.chart = echarts.init(document.getElementById('mainChart'));
                window.addEventListener('resize', () => this.chart.resize());
            }

            showChart() {
                if (!this.currentYear) return;
                this.updateChart();
                document.getElementById('chartModal').classList.add('active');
                setTimeout(() => this.chart.resize(), 100);
            }

            hideChart() {
                document.getElementById('chartModal').classList.remove('active');
            }

            updateChart() {
                const months = Array.from({ length: 12 }, (_, i) => `${i + 1}月`);
                const option = {
                    title: { text: `${this.currentYear}年度分析`, left: 'center' },
                    tooltip: { trigger: 'axis' },
                    xAxis: { type: 'category', data: months },
                    yAxis: { type: 'value' },
                    series: [{
                        type: 'line',
                        data: months.map(() => Math.random() * 100 + 50),
                        smooth: true
                    }]
                };
                this.chart.setOption(option);
            }

            bindEvents() {
                document.getElementById('yearInput').addEventListener('keypress', e => {
                    if (e.key === 'Enter') this.calculate();
                });

                document.getElementById('chartModal').addEventListener('click', e => {
                    if (e.target === document.getElementById('chartModal')) {
                        this.hideChart();
                    }
                });
            }
        }

        const system = new SolarSystem();
    </script>
</body>

</html>